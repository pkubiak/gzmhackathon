<!DOCTYPE html>
<html>
<head>

	<title>Quick Start - Leaflet</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/leaflet.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.4/leaflet.js" ></script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>


</head>
<body>



<div id="mapid" style="position: absolute; left:0; top: 0; right: 0; bottom: 0"></div>
<script>

	var metropolia = L.map('mapid').setView([51.505, -0.09], 13);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(metropolia);

var nodes = {};

$(function(){
  $.get('http://127.0.0.1:5000/stops/Będzin', function(data){
    let min_lat, max_lat, min_long, max_long;

    for(let key in data.nodes) {
      let node = data.nodes[key];
      if(node.lat < 1.0)continue;
      if(min_lat==undefined || min_lat > node.lat)min_lat = node.lat;
      if(min_long==undefined || min_long > node.long)min_long = node.long;
      if(max_lat==undefined || max_lat < node.lat)max_lat = node.lat;
      if(max_long==undefined || max_long < node.long)max_long = node.long;
      nodes[key] = [node.lat, node.long]
      marker = L.circleMarker(nodes[key], {'radius': 5, 'color': '#CA0072', 'fillColor': 'white', 'fillOpacity': 1.0}).addTo(metropolia).bindPopup(node.name);
    }
    var c1 = [230, 230, 230], c0 = [202, 0, 114];;

    for(let key in data.routes) {
      let route = key.split('_');
      console.log(key);
      if(route[0] in nodes && route[1] in nodes) {
        console.log(route);
        let r = Math.max(0.0, Math.min(1.0, data.routes[key].delay / 600));

        r = 0.9*r + 0.1; r = r*r;
        // r = r*r*r*r;
        c = [c0[0] * r + c1[0] * (1-r), c0[1] * r + c1[1] * (1-r), c0[2] * r + c1[2] * (1-r)]
        // color = 'rgba('+parseInt(c[0])+','+parseInt(c[1])+','+parseInt(c[2])+',1)';
        color = 'rgba(202, 0, 114, 1)';
        L.polyline(data.routes[key].points, {color: color, weight: 16*r+1}).addTo(metropolia).bindPopup('śr. opóźnienie: ' + data.routes[key].delay + 's');
      }
    }
    metropolia.fitBounds([[min_lat, min_long], [max_lat, max_long]]);
  });
});
</script>



</body>
</html>
